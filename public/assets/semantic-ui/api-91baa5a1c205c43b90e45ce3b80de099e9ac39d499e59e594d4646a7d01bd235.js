/*!
 * # Semantic UI - API
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Copyright 2015 Contributors
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */
!function(e,t,i,n){"use strict";e.api=e.fn.api=function(i){var a,o=e(e.isFunction(this)?t:this),r=o.selector||"",s=(new Date).getTime(),l=[],c=arguments[0],u="string"==typeof c,d=[].slice.call(arguments,1);return o.each(function(){var o,h,p,m,f,g,v=e.isPlainObject(i)?e.extend(!0,{},e.fn.api.settings,i):e.extend({},e.fn.api.settings),b=v.namespace,y=v.metadata,T=v.selector,k=v.error,C=v.className,E="."+b,w="module-"+b,D=e(this),I=D.closest(T.form),_=v.stateContext?e(v.stateContext):D,S=this,R=_[0],x=D.data(w);g={initialize:function(){u||g.bind.events(),g.instantiate()},instantiate:function(){g.verbose("Storing instance of module",g),x=g,D.data(w,x)},destroy:function(){g.verbose("Destroying previous module for",S),D.removeData(w).off(E)},bind:{events:function(){var e=g.get.event();e?(g.verbose("Attaching API events to element",e),D.on(e+E,g.event.trigger)):"now"==v.on&&(g.debug("Querying API endpoint immediately"),g.query())}},decode:{json:function(e){if(e!==n&&"string"==typeof e)try{e=JSON.parse(e)}catch(t){}return e}},read:{cachedResponse:function(e){var i;return t.Storage===n?void g.error(k.noStorage):(i=sessionStorage.getItem(e),g.debug("Using cached response",e,i),i=g.decode.json(i),!1)}},write:{cachedResponse:function(i,a){return a&&""===a?void g.debug("Response empty, not caching",a):t.Storage===n?void g.error(k.noStorage):(e.isPlainObject(a)&&(a=JSON.stringify(a)),sessionStorage.setItem(i,a),void g.verbose("Storing cached response for url",i,a))}},query:function(){if(g.is.disabled())return void g.debug("Element is disabled API request aborted");if(g.is.loading()){if(!v.interruptRequests)return void g.debug("Cancelling request, previous request is still pending");g.debug("Interrupting previous request"),g.abort()}return v.defaultData&&e.extend(!0,v.urlData,g.get.defaultData()),v.serializeForm&&(v.data=g.add.formData(v.data)),h=g.get.settings(),h===!1?(g.cancelled=!0,void g.error(k.beforeSend)):(g.cancelled=!1,p=g.get.templatedURL(),p||g.is.mocked()?(p=g.add.urlData(p),p||g.is.mocked()?(o=e.extend(!0,{},v,{type:v.method||v.type,data:m,url:v.base+p,beforeSend:v.beforeXHR,success:function(){},failure:function(){},complete:function(){}}),g.debug("Querying URL",o.url),g.verbose("Using AJAX settings",o),"local"===v.cache&&g.read.cachedResponse(p)?(g.debug("Response returned from local cache"),g.request=g.create.request(),void g.request.resolveWith(R,[g.read.cachedResponse(p)])):void(v.throttle?v.throttleFirstRequest||g.timer?(g.debug("Throttling request",v.throttle),clearTimeout(g.timer),g.timer=setTimeout(function(){g.timer&&delete g.timer,g.debug("Sending throttled request",m,o.method),g.send.request()},v.throttle)):(g.debug("Sending request",m,o.method),g.send.request(),g.timer=setTimeout(function(){},v.throttle)):(g.debug("Sending request",m,o.method),g.send.request()))):void 0):void g.error(k.missingURL))},should:{removeError:function(){return v.hideError===!0||"auto"===v.hideError&&!g.is.form()}},is:{disabled:function(){return D.filter(T.disabled).length>0},form:function(){return D.is("form")||_.is("form")},mocked:function(){return v.mockResponse||v.mockResponseAsync},input:function(){return D.is("input")},loading:function(){return g.request&&"pending"==g.request.state()},abortedRequest:function(e){return e&&e.readyState!==n&&0===e.readyState?(g.verbose("XHR request determined to be aborted"),!0):(g.verbose("XHR request was not aborted"),!1)},validResponse:function(t){return"json"!==v.dataType&&"jsonp"!==v.dataType||!e.isFunction(v.successTest)?(g.verbose("Response is not JSON, skipping validation",v.successTest,t),!0):(g.debug("Checking JSON returned success",v.successTest,t),v.successTest(t)?(g.debug("Response passed success test",t),!0):(g.debug("Response failed success test",t),!1))}},was:{cancelled:function(){return g.cancelled||!1},succesful:function(){return g.request&&"resolved"==g.request.state()},failure:function(){return g.request&&"rejected"==g.request.state()},complete:function(){return g.request&&("resolved"==g.request.state()||"rejected"==g.request.state())}},add:{urlData:function(t,i){var a,o;return t&&(a=t.match(v.regExp.required),o=t.match(v.regExp.optional),i=i||v.urlData,a&&(g.debug("Looking for required URL variables",a),e.each(a,function(a,o){var r=-1!==o.indexOf("$")?o.substr(2,o.length-3):o.substr(1,o.length-2),s=e.isPlainObject(i)&&i[r]!==n?i[r]:D.data(r)!==n?D.data(r):_.data(r)!==n?_.data(r):i[r];return s===n?(g.error(k.requiredParameter,r,t),t=!1,!1):(g.verbose("Found required variable",r,s),s=v.encodeParameters?g.get.urlEncodedValue(s):s,t=t.replace(o,s),void 0)})),o&&(g.debug("Looking for optional URL variables",a),e.each(o,function(a,o){var r=-1!==o.indexOf("$")?o.substr(3,o.length-4):o.substr(2,o.length-3),s=e.isPlainObject(i)&&i[r]!==n?i[r]:D.data(r)!==n?D.data(r):_.data(r)!==n?_.data(r):i[r];s!==n?(g.verbose("Optional variable Found",r,s),t=t.replace(o,s)):(g.verbose("Optional variable not found",r),t=-1!==t.indexOf("/"+o)?t.replace("/"+o,""):t.replace(o,""))}))),t},formData:function(t){var i,a=e.fn.serializeObject!==n,o=a?I.serializeObject():I.serialize();return t=t||v.data,i=e.isPlainObject(t),i?a?(g.debug("Extending existing data with form data",t,o),t=e.extend(!0,{},t,o)):(g.error(k.missingSerialize),g.debug("Cant extend data. Replacing data with form data",t,o),t=o):(g.debug("Adding form data",o),t=o),t}},send:{request:function(){g.set.loading(),g.request=g.create.request(),g.is.mocked()?g.mockedXHR=g.create.mockedXHR():g.xhr=g.create.xhr(),v.onRequest.call(R,g.request,g.xhr)}},event:{trigger:function(e){g.query(),("submit"==e.type||"click"==e.type)&&e.preventDefault()},xhr:{always:function(){},done:function(t,i,n){var a=this,o=(new Date).getTime()-f,r=v.loadingDuration-o,s=e.isFunction(v.onResponse)?v.onResponse.call(a,e.extend(!0,{},t)):!1;r=r>0?r:0,s&&(g.debug("Modified API response in onResponse callback",v.onResponse,s,t),t=s),r>0&&g.debug("Response completed early delaying state change by",r),setTimeout(function(){g.is.validResponse(t)?g.request.resolveWith(a,[t,n]):g.request.rejectWith(a,[n,"invalid"])},r)},fail:function(e,t,i){var n=this,a=(new Date).getTime()-f,o=v.loadingDuration-a;o=o>0?o:0,o>0&&g.debug("Response completed early delaying state change by",o),setTimeout(function(){g.is.abortedRequest(e)?g.request.rejectWith(n,[e,"aborted",i]):g.request.rejectWith(n,[e,"error",t,i])},o)}},request:{done:function(e,t){g.debug("Successful API Response",e),"local"===v.cache&&p&&(g.write.cachedResponse(p,e),g.debug("Saving server response locally",g.cache)),v.onSuccess.call(R,e,D,t)},complete:function(e,t){var i,n;g.was.succesful()?(n=e,i=t):(i=e,n=g.get.responseFromXHR(i)),g.remove.loading(),v.onComplete.call(R,n,D,i)},fail:function(e,t,i){var a=g.get.responseFromXHR(e),r=g.get.errorFromRequest(a,t,i);"aborted"==t?(g.debug("XHR Aborted (Most likely caused by page navigation or CORS Policy)",t,i),v.onAbort.call(R,t,D,e)):"invalid"==t?g.debug("JSON did not pass success test. A server-side error has most likely occurred",a):"error"==t&&e!==n&&(g.debug("XHR produced a server error",t,i),200!=e.status&&i!==n&&""!==i&&g.error(k.statusMessage+i,o.url),v.onError.call(R,r,D,e)),v.errorDuration&&"aborted"!==t&&(g.debug("Adding error state"),g.set.error(),g.should.removeError()&&setTimeout(g.remove.error,v.errorDuration)),g.debug("API Request failed",r,e),v.onFailure.call(R,a,D,e)}}},create:{request:function(){return e.Deferred().always(g.event.request.complete).done(g.event.request.done).fail(g.event.request.fail)},mockedXHR:function(){var t,i,n,a=!1,o=!1,r=!1;return n=e.Deferred().always(g.event.xhr.complete).done(g.event.xhr.done).fail(g.event.xhr.fail),v.mockResponse?(e.isFunction(v.mockResponse)?(g.debug("Using mocked callback returning response",v.mockResponse),i=v.mockResponse.call(R,v)):(g.debug("Using specified response",v.mockResponse),i=v.mockResponse),n.resolveWith(R,[i,a,{responseText:i}])):e.isFunction(v.mockResponseAsync)&&(t=function(e){g.debug("Async callback returned response",e),e?n.resolveWith(R,[e,a,{responseText:e}]):n.rejectWith(R,[{responseText:e},o,r])},g.debug("Using async mocked response",v.mockResponseAsync),v.mockResponseAsync.call(R,v,t)),n},xhr:function(){var t;return t=e.ajax(o).always(g.event.xhr.always).done(g.event.xhr.done).fail(g.event.xhr.fail),g.verbose("Created server request",t),t}},set:{error:function(){g.verbose("Adding error state to element",_),_.addClass(C.error)},loading:function(){g.verbose("Adding loading state to element",_),_.addClass(C.loading),f=(new Date).getTime()}},remove:{error:function(){g.verbose("Removing error state from element",_),_.removeClass(C.error)},loading:function(){g.verbose("Removing loading state from element",_),_.removeClass(C.loading)}},get:{responseFromXHR:function(t){return e.isPlainObject(t)?"json"==v.dataType||"jsonp"==v.dataType?g.decode.json(t.responseText):t.responseText:!1},errorFromRequest:function(t,i,a){return e.isPlainObject(t)&&t.error!==n?t.error:v.error[i]!==n?v.error[i]:a},request:function(){return g.request||!1},xhr:function(){return g.xhr||!1},settings:function(){var e;return e=v.beforeSend.call(R,v),e&&(e.success!==n&&(g.debug("Legacy success callback detected",e),g.error(k.legacyParameters,e.success),e.onSuccess=e.success),e.failure!==n&&(g.debug("Legacy failure callback detected",e),g.error(k.legacyParameters,e.failure),e.onFailure=e.failure),e.complete!==n&&(g.debug("Legacy complete callback detected",e),g.error(k.legacyParameters,e.complete),e.onComplete=e.complete)),e===n&&g.error(k.noReturnedValue),e!==n?e:v},urlEncodedValue:function(e){var i=t.decodeURIComponent(e),n=t.encodeURIComponent(e),a=i!==e;return a?(g.debug("URL value is already encoded, avoiding double encoding",e),e):(g.verbose("Encoding value using encodeURIComponent",e,n),n)},defaultData:function(){var t={};return e.isWindow(S)||(g.is.input()?t.value=D.val():g.is.form()&&(t.text=D.text())),t},event:function(){return e.isWindow(S)||"now"==v.on?(g.debug("API called without element, no events attached"),!1):"auto"==v.on?D.is("input")?S.oninput!==n?"input":S.onpropertychange!==n?"propertychange":"keyup":D.is("form")?"submit":"click":v.on},templatedURL:function(e){if(e=e||D.data(y.action)||v.action||!1,p=D.data(y.url)||v.url||!1)return g.debug("Using specified url",p),p;if(e){if(g.debug("Looking up url for action",e,v.api),v.api[e]===n&&!g.is.mocked())return void g.error(k.missingAction,v.action,v.api);p=v.api[e]}else g.is.form()&&(p=D.attr("action")||_.attr("action")||!1,g.debug("No url or action specified, defaulting to form action",p));return p}},abort:function(){var e=g.get.xhr();e&&"resolved"!==e.state()&&(g.debug("Cancelling API request"),e.abort())},reset:function(){g.remove.error(),g.remove.loading()},setting:function(t,i){if(g.debug("Changing setting",t,i),e.isPlainObject(t))e.extend(!0,v,t);else{if(i===n)return v[t];v[t]=i}},internal:function(t,i){if(e.isPlainObject(t))e.extend(!0,g,t);else{if(i===n)return g[t];g[t]=i}},debug:function(){v.debug&&(v.performance?g.performance.log(arguments):(g.debug=Function.prototype.bind.call(console.info,console,v.name+":"),g.debug.apply(console,arguments)))},verbose:function(){v.verbose&&v.debug&&(v.performance?g.performance.log(arguments):(g.verbose=Function.prototype.bind.call(console.info,console,v.name+":"),g.verbose.apply(console,arguments)))},error:function(){g.error=Function.prototype.bind.call(console.error,console,v.name+":"),g.error.apply(console,arguments)},performance:{log:function(e){var t,i,n;v.performance&&(t=(new Date).getTime(),n=s||t,i=t-n,s=t,l.push({Name:e[0],Arguments:[].slice.call(e,1)||"","Execution Time":i})),clearTimeout(g.performance.timer),g.performance.timer=setTimeout(g.performance.display,500)},display:function(){var t=v.name+":",i=0;s=!1,clearTimeout(g.performance.timer),e.each(l,function(e,t){i+=t["Execution Time"]}),t+=" "+i+"ms",r&&(t+=" '"+r+"'"),(console.group!==n||console.table!==n)&&l.length>0&&(console.groupCollapsed(t),console.table?console.table(l):e.each(l,function(e,t){console.log(t.Name+": "+t["Execution Time"]+"ms")}),console.groupEnd()),l=[]}},invoke:function(t,i,o){var r,s,l,c=x;return i=i||d,o=S||o,"string"==typeof t&&c!==n&&(t=t.split(/[\. ]/),r=t.length-1,e.each(t,function(i,a){var o=i!=r?a+t[i+1].charAt(0).toUpperCase()+t[i+1].slice(1):t;if(e.isPlainObject(c[o])&&i!=r)c=c[o];else{if(c[o]!==n)return s=c[o],!1;if(!e.isPlainObject(c[a])||i==r)return c[a]!==n?(s=c[a],!1):(g.error(k.method,t),!1);c=c[a]}})),e.isFunction(s)?l=s.apply(o,i):s!==n&&(l=s),e.isArray(a)?a.push(l):a!==n?a=[a,l]:l!==n&&(a=l),s}},u?(x===n&&g.initialize(),g.invoke(c)):(x!==n&&x.invoke("destroy"),g.initialize())}),a!==n?a:this},e.api.settings={name:"API",namespace:"api",debug:!1,verbose:!1,performance:!0,api:{},cache:!0,interruptRequests:!0,on:"auto",stateContext:!1,loadingDuration:0,hideError:"auto",errorDuration:2e3,encodeParameters:!0,action:!1,url:!1,base:"",urlData:{},defaultData:!0,serializeForm:!1,throttle:0,throttleFirstRequest:!0,method:"get",data:{},dataType:"json",mockResponse:!1,mockResponseAsync:!1,beforeSend:function(e){return e},beforeXHR:function(e){},onRequest:function(e,t){},onResponse:!1,onSuccess:function(e,t){},onComplete:function(e,t){},onFailure:function(e,t){},onError:function(e,t){},onAbort:function(e,t){},successTest:!1,error:{beforeSend:"The before send function has aborted the request",error:"There was an error with your request",exitConditions:"API Request Aborted. Exit conditions met",JSONParse:"JSON could not be parsed during error handling",legacyParameters:"You are using legacy API success callback names",method:"The method you called is not defined",missingAction:"API action used but no url was defined",missingSerialize:"jquery-serialize-object is required to add form data to an existing data object",missingURL:"No URL specified for api event",noReturnedValue:"The beforeSend callback must return a settings object, beforeSend ignored.",noStorage:"Caching respopnses locally requires session storage",parseError:"There was an error parsing your request",requiredParameter:"Missing a required URL parameter: ",statusMessage:"Server gave an error: ",timeout:"Your request timed out"},regExp:{required:/\{\$*[A-z0-9]+\}/g,optional:/\{\/\$*[A-z0-9]+\}/g},className:{loading:"loading",error:"error"},selector:{disabled:".disabled",form:"form"},metadata:{action:"action",url:"url"}}}(jQuery,window,document);